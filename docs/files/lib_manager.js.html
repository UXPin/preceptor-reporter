<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/manager.js - preceptor-reporter</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="preceptor-reporter"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AbstractListener.html">AbstractListener</a></li>
            
                <li><a href="../classes/AbstractMessenger.html">AbstractMessenger</a></li>
            
                <li><a href="../classes/AbstractReporter.html">AbstractReporter</a></li>
            
                <li><a href="../classes/DotReporter.html">DotReporter</a></li>
            
                <li><a href="../classes/DurationReporter.html">DurationReporter</a></li>
            
                <li><a href="../classes/EventReporter.html">EventReporter</a></li>
            
                <li><a href="../classes/Hooks.html">Hooks</a></li>
            
                <li><a href="../classes/Jenkins Sauce-Labs messenger.html">Jenkins Sauce-Labs messenger</a></li>
            
                <li><a href="../classes/JenkinsSauceLabsReporter.html">JenkinsSauceLabsReporter</a></li>
            
                <li><a href="../classes/JsonReporter.html">JsonReporter</a></li>
            
                <li><a href="../classes/JUnitReporter.html">JUnitReporter</a></li>
            
                <li><a href="../classes/LineSummaryReporter.html">LineSummaryReporter</a></li>
            
                <li><a href="../classes/ListReporter.html">ListReporter</a></li>
            
                <li><a href="../classes/PlainReporter.html">PlainReporter</a></li>
            
                <li><a href="../classes/PreceptorListener.html">PreceptorListener</a></li>
            
                <li><a href="../classes/PreceptorMessenger.html">PreceptorMessenger</a></li>
            
                <li><a href="../classes/PreceptorReporter.html">PreceptorReporter</a></li>
            
                <li><a href="../classes/ReportContainer.html">ReportContainer</a></li>
            
                <li><a href="../classes/ReportManager.html">ReportManager</a></li>
            
                <li><a href="../classes/SpecReporter.html">SpecReporter</a></li>
            
                <li><a href="../classes/SummaryReporter.html">SummaryReporter</a></li>
            
                <li><a href="../classes/TapReporter.html">TapReporter</a></li>
            
                <li><a href="../classes/TeamCity listener.html">TeamCity listener</a></li>
            
                <li><a href="../classes/TeamCity messenger.html">TeamCity messenger</a></li>
            
                <li><a href="../classes/TeamCityReporter.html">TeamCityReporter</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/manager.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// Copyright 2014, Yahoo! Inc.
// Copyrights licensed under the Mit License. See the accompanying LICENSE file for terms.

var Base = require(&#x27;preceptor-core&#x27;).Base;
var path = require(&#x27;path&#x27;);
var _ = require(&#x27;underscore&#x27;);

var ReportContainer = require(&#x27;./container&#x27;);

var EventReporter = require(&#x27;./reporter/event&#x27;);

var AbstractListener = require(&#x27;./abstractListener&#x27;);
var AbstractMessenger = require(&#x27;./abstractMessenger&#x27;);
var AbstractReporter = require(&#x27;./abstractReporter&#x27;);

/**
 * @class ReportManager
 * @extends Base
 *
 * @property {object} _options Options supplied when created
 * @property {ReportContainer} _container Report container
 *
 * @property {object} _reporterList Registered reporter
 * @property {AbstractReporter[]} _activeReporter Active reporter list
 *
 * @property {object} _listenerList Registered listener
 * @property {AbstractListener[]} _activeListener Active listener list
 *
 * @property {Event} _messageEvent Convenience reporter to trigger messages
 */
var ReportManager = Base.extend(

	/**
	 * Reporter manager constructor
	 *
	 * @param {object} [options]
	 * @param {object} [options.collect=true]
	 * @param {ReportContainer} [options.container]
	 * @constructor
	 */
	function (options) {
		this.__super();

		this._options = options || {};

		if (this._options.collect === undefined) {
			this._options.collect = true;
		}

		if (this._options.collect) {
			this._container = this._options.container || new ReportContainer();
		}

		this._reporterList = {};
		this._activeReporter = [];

		this._listenerList = {};
		this._activeListener = [];

		this._messageEvent = new EventReporter(null, { type:&#x27;Event&#x27; });

		this.initialize();
	},

	{
		/**
		 * Initializes the instance
		 *
		 * @method initialize
		 */
		initialize: function () {
			this._initializeReporterRegistry();
			this._initializeListenerRegistry();

			this._messageEvent.on(&#x27;message&#x27;, function (areaType, messageType, params) {
				this.processMessage(messageType, params);
			}.bind(this));
		},


		/**
		 * Initializes the reporter registry
		 *
		 * @method _initializeReporterRegistry
		 * @private
		 */
		_initializeReporterRegistry: function () {
			var defaultElements = [
				{ name: &#x27;Dot&#x27;, fileName: &#x27;dot&#x27; },
				{ name: &#x27;Duration&#x27;, fileName: &#x27;duration&#x27; },
				{ name: &#x27;Event&#x27;, fileName: &#x27;event&#x27; },
				{ name: &#x27;JenkinsSauceLabs&#x27;, fileName: &#x27;jenkinsSauceLabs&#x27; },
				{ name: &#x27;Json&#x27;, fileName: &#x27;json&#x27; },
				{ name: &#x27;Junit&#x27;, fileName: &#x27;junit&#x27; },
				{ name: &#x27;LineSummary&#x27;, fileName: &#x27;lineSummary&#x27; },
				{ name: &#x27;List&#x27;, fileName: &#x27;list&#x27; },
				{ name: &#x27;Plain&#x27;, fileName: &#x27;plain&#x27; },
				{ name: &#x27;Preceptor&#x27;, fileName: &#x27;preceptor&#x27; },
				{ name: &#x27;Spec&#x27;, fileName: &#x27;spec&#x27; },
				{ name: &#x27;Summary&#x27;, fileName: &#x27;summary&#x27; },
				{ name: &#x27;Tap&#x27;, fileName: &#x27;tap&#x27; },
				{ name: &#x27;TeamCity&#x27;, fileName: &#x27;teamCity&#x27; },
				{ name: &#x27;Intellij&#x27;, fileName: &#x27;teamCity&#x27; }
			];

			_.each(defaultElements, function (entry) {
				entry.path = path.join(__dirname, &#x27;reporter&#x27;, entry.fileName);
				entry.fn = require(entry.path);
			}, this);

			this.registerReporterRange(defaultElements);
		},

		/**
		 * Initializes the listener registry
		 *
		 * @method _initializeListenerRegistry
		 * @private
		 */
		_initializeListenerRegistry: function () {
			var defaultElements = [
				{ name: &#x27;Preceptor&#x27;, fileName: &#x27;preceptor&#x27; },
				{ name: &#x27;TeamCity&#x27;, fileName: &#x27;teamCity&#x27; },
				{ name: &#x27;Intellij&#x27;, fileName: &#x27;teamCity&#x27; }
			];

			_.each(defaultElements, function (entry) {
				entry.path = path.join(__dirname, &#x27;listener&#x27;, entry.fileName);
				entry.fn = require(entry.path);
			}, this);

			this.registerListenerRange(defaultElements);
		},


		/**
		 * Should report-manager collect events?
		 *
		 * @method shouldCollect
		 * @return {boolean}
		 */
		shouldCollect: function () {
			return this.getOptions().collect;
		},


		/**
		 * Gets the options
		 *
		 * @method getOptions
		 * @return {object}
		 */
		getOptions: function () {
			return this._options;
		},

		/**
		 * Gets the container of messages
		 *
		 * @method getContainer
		 * @return {ReportContainer}
		 */
		getContainer: function () {
			return this._container;
		},


		/**
		 * Gets all the active reporter
		 *
		 * @method getActiveReporter
		 * @return {AbstractReporter[]}
		 */
		getActiveReporter: function () {
			return this._activeReporter;
		},

		/**
		 * Gets a dictionary of registered reporter
		 *
		 * @method getReporterList
		 * @return {object}
		 */
		getReporterList: function () {
			return this._reporterList;
		},


		/**
		 * Checks if a reporter is registered
		 *
		 * @method hasReporter
		 * @param {string} name
		 * @return {boolean}
		 */
		hasReporter: function (name) {
			return !!this._reporterList[name];
		},

		/**
		 * Gets a specific registered reporter
		 *
		 * @method getReporter
		 * @param {string} name
		 * @return {function}
		 */
		getReporter: function (name) {
			return this._reporterList[name];
		},

		/**
		 * Registers a reporter
		 *
		 * @method registerReporter
		 * @param {string} name
		 * @param {function} contr
		 */
		registerReporter: function (name, contr) {
			this._reporterList[name] = contr;
		},

		/**
		 * Registers a list of reporters
		 *
		 * @method registerReporterRange
		 * @param {object[]} list Of &#x60;{ name: &lt;string&gt;, fn: &lt;function&gt; }&#x60;
		 */
		registerReporterRange: function (list) {

			_.each(list, function (entry) {
				this.registerReporter(entry.name, entry.fn);
			}, this);
		},


		/**
		 * Adds a new reporter to the list of active reporters
		 *
		 * @method addReporter
		 * @param {string} name
		 * @param {object} [options]
		 * @return {AbstractReporter}
		 */
		addReporter: function (name, options) {
			var Class = this.getReporter(name),
				instance;

			if (!Class) {
				throw new Error(&#x27;Unknown reporter &quot;&#x27; + name + &#x27;&quot;&#x27;);
			}

			options = options || {};
			if (!options.type) {
				options.type = name;
			}

			instance = new Class(this.getContainer(), options);
			this.getActiveReporter().push(instance);
			return instance;
		},

		/**
		 * Adds a new reporter to the list of active reporters
		 *
		 * @method addReporterRange
		 * @param {string|string[]|object|object[]} reporter
		 * @return {AbstractReporter[]}
		 */
		addReporterRange: function (reporter) {
			var result = [];

			reporter = this._normalizeReporter(reporter);

			_.each(reporter, function (entry) {
				result.push(this.addReporter(entry.type, entry));
			}, this);

			return result;
		},

		/**
		 * Normalizes the reporter
		 *
		 * @method _normalizeReporter
		 * @param {string|string[]|object|object[]} reporter
		 * @return {object[]}
		 * @private
		 */
		_normalizeReporter: function (reporter) {
			var newReporter,
				localReporter = reporter;

			// Convert to array
			if (_.isString(localReporter)) {
				localReporter = [localReporter];
			} else if (!_.isArray(localReporter) &amp;&amp; _.isObject(localReporter)) {
				localReporter = [localReporter];
			}

			// Format array as needed by the function
			if (_.isArray(localReporter)) {

				newReporter = [];
				_.each(localReporter, function (currentReporter) {

					if (_.isString(currentReporter)) {
						newReporter.push({ type: currentReporter });

					} else if (_.isObject(currentReporter)) {
						newReporter.push(currentReporter);
					}
				});
				localReporter = newReporter;
			}

			return localReporter;
		},



		/**
		 * Gets all the active listener
		 *
		 * @method getActiveListener
		 * @return {AbstractListener[]}
		 */
		getActiveListener: function () {
			return this._activeListener;
		},

		/**
		 * Gets a dictionary of registered listener
		 *
		 * @method getListenerList
		 * @return {object}
		 */
		getListenerList: function () {
			return this._listenerList;
		},


		/**
		 * Checks if a listener is registered
		 *
		 * @method hasListener
		 * @param {string} name
		 * @return {boolean}
		 */
		hasListener: function (name) {
			return !!this._listenerList[name];
		},

		/**
		 * Gets a specific registered listener
		 *
		 * @method getListener
		 * @param {string} name
		 * @return {function}
		 */
		getListener: function (name) {
			return this._listenerList[name];
		},

		/**
		 * Registers a listener
		 *
		 * @method registerListener
		 * @param {string} name
		 * @param {function} contr
		 */
		registerListener: function (name, contr) {
			this._listenerList[name] = contr;
		},

		/**
		 * Registers a list of listeners
		 *
		 * @method registerListenerRange
		 * @param {object[]} list &#x60;{ name: &lt;string&gt;, fn: &lt;function&gt; }&#x60;
		 */
		registerListenerRange: function (list) {

			_.each(list, function (entry) {
				this.registerListener(entry.name, entry.fn);
			}, this);
		},


		/**
		 * Adds a new listener to the list of active listeners
		 *
		 * @method addListener
		 * @param {string} name
		 * @param {object} [options]
		 * @return {AbstractListener}
		 */
		addListener: function (name, options) {
			var Class = this.getListener(name),
				instance;

			if (!Class) {
				throw new Error(&#x27;Unknown listener &quot;&#x27; + name + &#x27;&quot;&#x27;);
			}

			options = options || {};
			if (!options.type) {
				options.type = name;
			}

			instance = new Class(this.getContainer(), options);
			instance.on(&#x27;message&#x27;, function (messageType, data) {
				this.processMessage(messageType, data);
			}.bind(this));
			this.getActiveListener().push(instance);
			return instance;
		},

		/**
		 * Adds a new listener to the list of active listeners
		 *
		 * @method addListenerRange
		 * @param {string|string[]|object|object[]} listener
		 * @return {AbstractListener[]}
		 */
		addListenerRange: function (listener) {
			var result = [];

			listener = this._normalizeListener(listener);

			_.each(listener, function (entry) {
				result.push(this.addListener(entry.type, entry));
			}, this);

			return result;
		},

		/**
		 * Normalizes the listener
		 *
		 * @method _normalizeListener
		 * @param {string|string[]|object|object[]} listener
		 * @return {object[]}
		 * @private
		 */
		_normalizeListener: function (listener) {
			var newListener,
				localListener = listener;

			// Convert to array
			if (_.isString(localListener)) {
				localListener = [localListener];
			} else if (!_.isArray(localListener) &amp;&amp; _.isObject(localListener)) {
				localListener = [localListener];
			}

			// Format array as needed by the function
			if (_.isArray(localListener)) {

				newListener = [];
				_.each(localListener, function (currentListener) {

					if (_.isString(currentListener)) {
						newListener.push({ type: currentListener });

					} else if (_.isObject(currentListener)) {
						newListener.push(currentListener);
					}
				});
				localListener = newListener;
			}

			return localListener;
		},


		/**
		 * Gets a list of allowed messages
		 *
		 * @method getAllowedMessages
		 * @return {string[]}
		 */
		getAllowedMessages: function () {
			return [
				&#x27;start&#x27;,
				&#x27;stop&#x27;,
				&#x27;complete&#x27;,
				&#x27;itemData&#x27;,
				&#x27;itemMessage&#x27;,
				&#x27;suiteStart&#x27;,
				&#x27;suiteEnd&#x27;,
				&#x27;testStart&#x27;,
				&#x27;testFailed&#x27;,
				&#x27;testUndefined&#x27;,
				&#x27;testError&#x27;,
				&#x27;testPassed&#x27;,
				&#x27;testSkipped&#x27;,
				&#x27;testIncomplete&#x27;
			];
		},

		/**
		 * Processes a message by sending it to all attached reporter
		 *
		 * @method processMessage
		 * @param {string} messageType
		 * @param {*[]} data
		 */
		processMessage: function (messageType, data) {

			var container = this.getContainer();

			if (this.getAllowedMessages().indexOf(messageType) === -1) {
				throw new Error(&#x27;The message is not allowed to be relayed to the reporter. &quot;&#x27; + messageType + &#x27;&quot;&#x27;);
			}

			// Send to container
			if (this.shouldCollect()) {
				container[messageType].apply(container, data);
			}

			// Send to reporter
			_.each(this.getActiveReporter(), function (reporter) {
				reporter[messageType].apply(reporter, data);
			});
		},

		/**
		 * Returns a convenience object to trigger messages
		 *
		 * @method message
		 * @return {Event}
		 */
		message: function () {
			return this._messageEvent;
		},


		/**
		 * Parses a string to see if any listener can receive messages from it
		 *
		 * @method parse
		 * @param {string} text
		 * @param {object} [placeholder]
		 * @return {string}
		 */
		parse: function (text, placeholder) {
			var localText = text;

			_.each(this.getActiveListener(), function (listener) {
				localText = listener.parse(localText, placeholder);
			});

			return localText;
		},

		/**
		 * Loads a reporter hook and returns the system specific function to be supplied to the system
		 *
		 * @method loadHook
		 * @param {string} type
		 * @param {string|undefined} reportId
		 * @param {function} [finishedCallback]
		 * @return {function}
		 */
		loadHook: function (type, reportId, finishedCallback) {
			var hooks = ReportManager.getReporterHooks();

			if (hooks.hasOwnProperty(type)) {
				return hooks[type](this, reportId, finishedCallback);
			} else {
				throw new Error(&#x27;Unknown reporter hook &#x27; + type);
			}
		},


		/**
		 * Clears all run-data
		 *
		 * @method clear
		 */
		clear: function () {
			if (this.shouldCollect()) {
				this._container = new ReportContainer();
			}
			this._activeReporter = [];
			this._activeListener = [];
		}
	},

	{
		/**
		 * @var string
		 */
		TYPE: &#x27;ReportManager&#x27;
	});

// Make abstract classes available to external project
/**
 * @property AbstractListener
 * @type {AbstractListener}
 * @static
 */
ReportManager.AbstractListener = AbstractListener;

/**
 * @property AbstractMessenger
 * @type {AbstractMessenger}
 * @static
 */
ReportManager.AbstractMessenger = AbstractMessenger;

/**
 * @property AbstractReporter
 * @type {AbstractReporter}
 * @static
 */
ReportManager.AbstractReporter = AbstractReporter;


/**
 * Gets a list of messengers
 *
 * @static
 * @method getMessengers
 * @return {object}
 */
ReportManager.getMessengers = function () {
	return {
		&quot;JenkinsSauceLabs&quot;: require(&#x27;./messenger/jenkinsSauceLabs&#x27;),
		&quot;TeamCity&quot;: require(&#x27;./messenger/teamCity&#x27;),
		&quot;Preceptor&quot;: require(&#x27;./messenger/preceptor&#x27;)
	};
};

/**
 * Gets a list of reporter-hooks
 *
 * @static
 * @method getReporterHooks
 * @return {object}
 */
ReportManager.getReporterHooks = function () {
	return {
		&quot;cucumber&quot;: require(&#x27;./reporterHooks/cucumber&#x27;),
		&quot;mocha&quot;: require(&#x27;./reporterHooks/mocha&#x27;)
	};
};

/**
 * Gets the module version
 *
 * @static
 * @method version
 * @return {string}
 */
ReportManager.version = require(&#x27;../package.json&#x27;).version;

module.exports = ReportManager;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
